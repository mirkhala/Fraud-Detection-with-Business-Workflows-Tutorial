---
- name: Tasks to check Nodes Status
  block:
    - name: Check status of created OCS Nodes
      k8s_info:
        api_key: "{{ k8s_auth_results.k8s_auth.api_key }}"
        api_version: v1
        kind: Node
        label_selectors:
          - cluster.ocs.openshift.io/openshift-storage
      register: nodes

    - name: Store nodes status
      set_fact:
        nodes_status_list: "{{ nodes.resources |json_query(query) | unique }}"
      vars:
        query: "[].status.conditions[?type=='Ready'].status[]"

    - name: Check if ready
      fail: 
        msg: not ready
      when: ((nodes_status_list | length == 1) and ('True' in nodes_status_list) ) == False
  rescue:
    - debug:
        msg: 
          - "length = {{Â nodes.resources |json_query(query) |unique|length }}"
          - "nodes_status_list = {{ nodes_status_list }}"
          - "{{(nodes_status_list | length ==1) and ('True' in nodes_status_list)}} "
      vars:
        query: "[].status.phase"

    - include_tasks: check_ocp_nodes_ocs.yml 
        
