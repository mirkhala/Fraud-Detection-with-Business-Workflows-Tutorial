---
- name: Wait for secret creation
  pause:
    seconds: 60

- name: Get Secret
  k8s_info:
    api_version: v1
    kind: Secret
    name: ccdata
    namespace: ccfd
    api_key: "{{ k8s_auth_results.k8s_auth.api_key }}"
  register: secret_list

- name: Store secret facts
  set_fact:
    bucket_access_key: "{{ secret_list.resources[0].data.AWS_ACCESS_KEY_ID | b64decode }}"
    bucket_secret_key: "{{ secret_list.resources[0].data.AWS_SECRET_ACCESS_KEY | b64decode }}"

- name: Get Config Map
  k8s_info:
    api_version: v1
    kind: ConfigMap
    name: ccdata
    namespace: ccfd
    api_key: "{{ k8s_auth_results.k8s_auth.api_key }}"
  register: cm_list

- name: Store bucket name
  set_fact:
    bucket_name: "{{ cm_list.resources[0].data.BUCKET_NAME }}"
    host_internal_access: "{{ cm_list.resources[0].data.BUCKET_HOST }}"

- name: Show Host(Internal Access)
  debug:
    msg: "http://{{ host_internal_access }}"

- name: Get External Access (Route)
  k8s_info:
    api_version: route.openshift.io/v1
    kind: Route
    name: "{{ s3_name }}"
    namespace: "{{ ocs_ns }}"
    api_key: "{{ k8s_auth_results.k8s_auth.api_key }}"
  register: route_list
    
- name: Store host_external_access
  set_fact:
    host_external_access: "https://{{ route_list.resources[0].spec.host }}"

- name: Show Host(External Access)
  debug:
    msg: host_external_access

- name: Create Secret to store keys
  k8s:
    api_key: "{{ k8s_auth_results.k8s_auth.api_key }}"
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        namespace: "{{ demo_name }}"
        name: keysecret
      data:
        accesskey: "{{ bucket_access_key | b64encode }}"
        secretkey: "{{ bucket_secret_key | b64encode }}"

- name: Set CSV filename/path
  set_fact:
    csv_datafile: /tmp/data_creditcard.csv
    
- name: Get CSV Data
  get_url:
    url: "{{ csv_url }}"
    dest: "{{ csv_datafile }}" 

- name: Upload CSV to Bucket
  aws_s3:
    aws_access_key: "{{ bucket_access_key }}"
    aws_secret_key: "{{ bucket_secret_key }}"
    s3_url: "{{ host_external_access }}"
    bucket: "{{ bucket_name }}"
    src: "{{ csv_datafile }}"
    object: "/OPEN/uploaded/creditcard.csv"
    mode: put
    permission: 
      - public-read-write
    validate_certs: true
    encrypt: false
    rgw: yes
